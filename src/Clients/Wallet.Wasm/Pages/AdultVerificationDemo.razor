@page "/adult-demo"
@using Wallet.Wasm.Models
@using Wallet.Wasm.Services
@using Wallet.Wasm.Utilities
@inject WalletService WalletService
@inject AdultClient AdultClient

<PageTitle>Adult Demo</PageTitle>

<div class="container mt-4">
    <h2>Adult Verification Demo</h2>
    <p class="text-muted">
        Demo af client-side verification (lokalt i browseren) og server-side verification (API-kald).
    </p>

    @if (_isLoading)
    {
        <div class="alert alert-info">Loader lokal token...</div>
    }
    else if (_token is null)
    {
        <div class="alert alert-warning">
            Ingen token fundet i denne browser.
            <a class="alert-link" href="/wallet/import">ImportÃ©r token</a>
        </div>
    }
    else
    {

    <div class="row g-3">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                <div class="card-body">
                    <h5 class="card-title">ðŸ”ž Voksenindhold (Simulering)</h5>
                    <p class="text-muted">
                        Dette er en "ekstern" hjemmeside, der krÃ¦ver, at du er over 18 Ã¥r.
                        Den kigger i din E-Wallet for at se, om du har et gyldigt bevis.
                    </p>

                    <ul class="mb-3">
                        <li>Har bevis: <strong>@(_token != null ? "Ja" : "Nej")</strong></li>
                        <li>Er 18+ (ifÃ¸lge bevis): <strong>@(ClientSideAdult ? "Ja" : "Nej")</strong></li>
                    </ul>

                    @if (ClientSideAdult)
                    {
                        <div class="alert alert-success">
                            <h4>ðŸŽ‰ Adgang Godkendt!</h4>
                            <p>Du har bevist din alder med din wallet uden at afslÃ¸re dit CPR-nummer.</p>
                            <p><em>(Her ville du normalt blive sendt videre til indholdet...)</em></p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <h4>â›” Adgang NÃ¦gtet</h4>
                            <p>Du har ikke et gyldigt 18+ bevis i din wallet.</p>
                        </div>
                    }

                    <details class="mt-3">
                        <summary>Vis pseudo-kode (JS)</summary>
                        <pre class="small mt-2"><code>@ClientSideJsExample</code></pre>
                    </details>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Server-side verification</h5>
                    <p class="text-muted">
                        Tjek via backend API. Bruges typisk nÃ¥r et website vil validere uden at stole pÃ¥ client-side.
                    </p>

                    <button class="btn btn-secondary" @onclick="VerifyServerSideAsync" disabled="_serverBusy">
                        @(_serverBusy ? "Verifierer..." : "KÃ¸r server-side check")
                    </button>

                    @if (_serverMessage is not null)
                    {
                        <div class="alert mt-3 @(_serverIsAdult ? "alert-success" : "alert-danger")">
                            @_serverMessage
                        </div>
                    }

                    <details class="mt-3">
                        <summary>Vis pseudo-kode (C#)</summary>
                        <pre class="small mt-2"><code>@ServerSideCSharpExample</code></pre>
                    </details>
                </div>
            </div>
        </div>
    </div>
    }
</div>

@code {
    private LocalWalletToken? _token;
    private bool _anchorMatches;
    private bool _isLoading = true;

    private bool _serverBusy;
    private bool _serverIsAdult;
    private string? _serverMessage;

    private bool ClientSideAdult 
    {
        get 
        {
            if (_token is null) return false;
            if (_token.Claims.TryGetValue("IsAdult", out var isAdultStr))
            {
                return bool.TryParse(isAdultStr, out var b) && b;
            }
            return false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Get the specific AdultCredential we just issued
        var tokens = await WalletService.GetMyTokensAsync();
        _token = tokens.FirstOrDefault(t => t.Type == "AdultCredential");
        
        // Mock check for anchor match (in real app, this verifies signature against chain)
        _anchorMatches = _token is not null; 
        _isLoading = false;
    }

    private async Task VerifyServerSideAsync()
    {
        if (_token is null) return;

        _serverBusy = true;
        _serverMessage = null;

        try
        {
            // Hvis jeres backend bruger tokenId (typisk), sÃ¥ kÃ¸r sÃ¥dan her:
            var result = await AdultClient.VerifyAdultAsync(_token.TokenId);

            if (result is null)
            {
                _serverIsAdult = false;
                _serverMessage = "Server-side verifikation fejlede (intet svar fra API).";
                return;
            }

            _serverIsAdult = result.IsAdult;
            _serverMessage = _serverIsAdult
                ? "Server-side: Brugeren er verificeret som 18+."
                : "Server-side: Brugeren er ikke 18+ (eller token er ugyldig/udlÃ¸bet).";
        }
        finally
        {
            _serverBusy = false;
        }
    }

    private const string ClientSideJsExample =
@"// Client-side (browser):
// 1) LÃ¦s token fra localStorage (pÃ¥ wallet-domÃ¦net)
// 2) Check expiry + type
// 3) Hash rawToken og sammenlign med anchorHashOnChain
const tokenJson = localStorage.getItem('wallet.local.token.v1');
if (!tokenJson) return { isAdult: false };

const token = JSON.parse(tokenJson);
const isActive = new Date(token.expiresAt) > new Date();
const isAdultType = token.type === 'AgeOver18';

const buf = new TextEncoder().encode(token.rawToken);
const hash = await crypto.subtle.digest('SHA-256', buf);
// convert hash -> hex og sammenlign med token.anchorHashOnChain";

    private const string ServerSideCSharpExample =
@"// Server-side (kundens backend):
// Send tokenId til jeres backend:
var response = await http.PostAsJsonAsync(
    '/api/adult/verify',
    new { tokenId }
);

var result = await response.Content.ReadFromJsonAsync<AdultVerificationResultDto>();
if (result?.IsAdult == true) { /* allow adult content */ }";
}
