@page "/adult-demo"
@using Wallet.Wasm.Models
@using Wallet.Wasm.Services
@using Wallet.Wasm.Utilities
@inject WalletService WalletService
@inject AdultClient AdultClient

<PageTitle>Adult Demo</PageTitle>

<div class="container mt-4">
    <h2>Adult Verification Demo</h2>
    <p class="text-muted">
        Demo af client-side verification (lokalt i browseren) og server-side verification (API-kald).
    </p>

    @if (_isLoading)
    {
        <div class="alert alert-info">Loader lokal token...</div>
    }
    else if (_token is null)
    {
        <div class="alert alert-warning">
            Ingen token fundet i denne browser.
            <a class="alert-link" href="/wallet/import">Import√©r token</a>
        </div>
    }
    else
    {
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">üîû Voksenindhold (Simulering)</h5>
                        <p class="text-muted">
                            Dette er en "ekstern" hjemmeside, der kr√¶ver, at du er over 18 √•r.
                            Den kigger i din E-Wallet for at se, om du har et gyldigt bevis.
                        </p>

                        <ul class="mb-3">
                            <li>Har bevis: <strong>@(_token != null ? "Ja" : "Nej")</strong></li>
                            <li>Er 18+ (if√∏lge bevis): <strong>@(ClientSideAdult ? "Ja" : "Nej")</strong></li>
                        </ul>

                        @if (ClientSideAdult)
                        {
                            <div class="alert alert-success">
                                <h4>üéâ Adgang Godkendt!</h4>
                                <p>Du har bevist din alder med din wallet uden at afsl√∏re dit CPR-nummer.</p>
                                <p><em>(Her ville du normalt blive sendt videre til indholdet...)</em></p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <h4>‚õî Adgang N√¶gtet</h4>
                                <p>Du har ikke et gyldigt 18+ bevis i din wallet.</p>
                            </div>
                        }

                        <details class="mt-3">
                            <summary>Vis pseudo-kode (JS)</summary>
                            <pre class="small mt-2"><code>@ClientSideJsExample</code></pre>
                        </details>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Server-side verification</h5>
                        <p class="text-muted">
                            Tjek via backend API. Bruges typisk n√•r et website vil validere uden at stole p√• client-side.
                        </p>

                        <button class="btn btn-secondary" @onclick="VerifyServerSideAsync" disabled="@_serverBusy">
                            @(_serverBusy ? "Verifierer..." : "K√∏r server-side check")
                        </button>

                        @if (_serverResult is not null)
                        {
                            <div class="alert mt-3 @(_serverResult.IsVerified ? "alert-success" : "alert-danger")">
                                @if (_serverResult.IsVerified)
                                {
                                    <div class="fw-bold">MitID/VC godkendt ‚úÖ</div>
                                    <div class="small text-muted">
                                        Issuer: @_serverResult.IssuerDid ?? "ukendt" <br />
                                        Tid: @_serverResult.VerifiedAt.ToString("u")
                                    </div>
                                }
                                else
                                {
                                    <div class="fw-bold">Ikke godkendt ‚ùå</div>
                                    <div class="small">
                                        @_serverResult.FailureReason ?? "ukendt √•rsag"
                                    </div>
                                }
                            </div>
                        }
                        else if (_serverAutoTried)
                        {
                            <div class="alert mt-3 alert-warning">
                                Server-side check blev fors√∏gt, men gav intet svar.
                            </div>
                        }

                        <details class="mt-3">
                            <summary>Vis pseudo-kode (C#)</summary>
                            <pre class="small mt-2"><code>@ServerSideCSharpExample</code></pre>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private LocalWalletToken? _token;
    private bool _isLoading = true;

    private bool _serverBusy;
    private bool _serverAutoTried;
    private AdultVerificationResultDto? _serverResult;

    private bool ClientSideAdult
    {
        get
        {
            if (_token is null) return false;
            if (_token.Claims.TryGetValue("IsAdult", out var isAdultStr))
            {
                return bool.TryParse(isAdultStr, out var b) && b;
            }
            return false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var tokens = await WalletService.GetMyTokensAsync();
        _token = tokens.FirstOrDefault(t => t.Type == "AdultCredential");
        _isLoading = false;

        // ‚úÖ Auto-run server-side verify s√• h√∏jre side ‚Äúsiger det‚Äù direkte
        if (_token is not null)
        {
            await VerifyServerSideAsync(auto: true);
        }
    }

    private async Task VerifyServerSideAsync() => await VerifyServerSideAsync(auto: false);

    private async Task VerifyServerSideAsync(bool auto)
    {
        if (_token is null) return;

        _serverBusy = true;
        _serverResult = null;

        try
        {
            if (!_token.Claims.TryGetValue("VC_JWT", out var vcJwt) || string.IsNullOrWhiteSpace(vcJwt))
            {
                _serverResult = new AdultVerificationResultDto
                {
                    IsVerified = false,
                    IsAdult = false,
                    FailureReason = "Token mangler VC_JWT claim (kan ikke validere).",
                    VerifiedAt = DateTime.UtcNow
                };
                return;
            }

            var result = await AdultClient.VerifyAdultAsync(vcJwt);

            _serverResult = result ?? new AdultVerificationResultDto
            {
                IsVerified = false,
                IsAdult = false,
                FailureReason = "Intet svar fra API.",
                VerifiedAt = DateTime.UtcNow
            };
        }
        finally
        {
            _serverBusy = false;
            if (auto) _serverAutoTried = true;
        }
    }

    private const string ClientSideJsExample =
@"// Client-side (browser):
// 1) L√¶s token fra localStorage (p√• wallet-dom√¶net)
// 2) Check expiry + type
// 3) Hash rawToken og sammenlign med anchorHashOnChain";

    private const string ServerSideCSharpExample =
@"// Server-side:
// POST /api/validation/verify { vcJwt: '...' }";
}
