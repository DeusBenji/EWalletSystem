@page "/wallet"
@using Wallet.Wasm.Models
@using Wallet.Wasm.Services
@inject WalletService WalletService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>My Wallet</PageTitle>

<h1>My Wallet</h1>
<p>Manage your local identity credentials securely off-chain.</p>

@if (_tokens == null)
{
    <p><em>Loading your wallet...</em></p>
}
else if (!_tokens.Any())
{
    <div class="alert alert-warning">
        Your wallet is empty. <a href="wallet/import">Import a token</a> to get started.
    </div>
}
else
{
    <div class="row">
        @foreach (var token in _tokens)
        {
            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span>@token.Type</span>
                        @if (token.IsExpired)
                        {
                            <span class="badge bg-danger">Expired</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Active</span>
                        }
                    </div>

                    <div class="card-body">
                        <h5 class="card-title">@token.Issuer</h5>
                        <p class="card-text text-muted small mb-3">
                            ID: @ShortId(token.TokenId)
                        </p>

                        <h6 class="mb-2">Claims</h6>

                        <div class="list-group mb-3">
                            @foreach (var claim in token.Claims.OrderBy(c => c.Key))
                            {
                                var key = claim.Key;
                                var value = claim.Value ?? "";
                                var isLong = value.Length > 120;
                                var isExpanded = _expandedClaims.Contains((token.TokenId, key));

                                // Hide VC_JWT by default behind a more controlled rendering
                                if (key == "VC_JWT")
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="fw-semibold">VC_JWT</div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" @onclick="() => CopyToClipboard(value)">
                                                    Copy
                                                </button>
                                                <button class="btn btn-outline-primary" @onclick="() => ToggleClaim(token.TokenId, key)">
                                                    @(isExpanded ? "Hide" : "Show")
                                                </button>
                                            </div>
                                        </div>

                                        <div class="text-muted small mt-2">
                                            @(isExpanded
                                                                        ? "Full token shown below."
                                                                        : $"Preview: {Truncate(value, 60)}")
                                        </div>

                                        @if (isExpanded)
                                        {
                                            <div class="mt-2 p-2 border rounded bg-light">
                                                <code class="d-block" style="white-space: pre-wrap; word-break: break-word; font-size: .85rem;">
                                                    @value
                                                </code>
                                            </div>
                                        }
                                    </div>

                                    continue;
                                }

                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start gap-3">
                                        <div class="fw-semibold">@key</div>

                                        <div class="text-end">
                                            @if (!isLong)
                                            {
                                                <span class="fw-bold">@value</span>
                                            }
                                            else
                                            {
                                                <span class="fw-bold">@Truncate(value, 120)</span>
                                            }
                                        </div>
                                    </div>

                                    @if (isLong)
                                    {
                                        <div class="d-flex justify-content-end mt-2">
                                            <button class="btn btn-link btn-sm p-0" @onclick="() => ToggleClaim(token.TokenId, key)">
                                                @(isExpanded ? "Show less" : "Show more")
                                            </button>
                                        </div>

                                        @if (isExpanded)
                                        {
                                            <div class="mt-2 p-2 border rounded bg-light">
                                                <code class="d-block" style="white-space: pre-wrap; word-break: break-word; font-size: .85rem;">
                                                    @value
                                                </code>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Expires: @token.ExpiresAt.ToShortDateString()</small>
                            <div>
                                <button class="btn btn-outline-danger btn-sm me-2" @onclick="() => Delete(token.TokenId)">
                                    <span class="bi bi-trash"></span>
                                </button>
                                <button class="btn btn-outline-primary btn-sm" @onclick="() => Verify(token)">
                                    Verify locally
                                </button>
                            </div>
                        </div>

                        @if (_verificationResults.TryGetValue(token.TokenId, out var isValid))
                        {
                            <div class="mt-2 alert @(isValid ? "alert-success" : "alert-danger") py-1 px-2 mb-0">
                                Local Verification: @(isValid ? "PASSED" : "FAILED")
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<LocalWalletToken>? _tokens;
    private Dictionary<string, bool> _verificationResults = new();

    // Track expanded claim values per token+key
    private readonly HashSet<(string TokenId, string Key)> _expandedClaims = new();

    protected override async Task OnInitializedAsync()
    {
        _tokens = await WalletService.GetMyTokensAsync();
    }

    private void Verify(LocalWalletToken token)
    {
        var result = WalletService.VerifyTokenLocally(token);
        _verificationResults[token.TokenId] = result;
    }

    private async Task Delete(string tokenId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this token?"))
        {
            await WalletService.DeleteTokenAsync(tokenId);
            _tokens = await WalletService.GetMyTokensAsync();
        }
    }

    private void ToggleClaim(string tokenId, string key)
    {
        var tuple = (tokenId, key);
        if (_expandedClaims.Contains(tuple))
            _expandedClaims.Remove(tuple);
        else
            _expandedClaims.Add(tuple);
    }

    private static string ShortId(string id)
        => string.IsNullOrWhiteSpace(id) ? "" : (id.Length > 8 ? id.Substring(0, 8) + "…" : id);

    private static string Truncate(string s, int max)
        => string.IsNullOrEmpty(s) ? "" : (s.Length <= max ? s : s.Substring(0, max) + "…");

    private async Task CopyToClipboard(string text)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
    }
}
