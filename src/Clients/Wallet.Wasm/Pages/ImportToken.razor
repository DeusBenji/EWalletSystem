@page "/wallet/import"
@using Wallet.Wasm.Services
@inject NavigationManager Nav
@inject WalletStorage WalletStorage
@inject WalletService WalletService

<PageTitle>Import Identity Token</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Import Identity Token</h4>
            </div>

            <div class="card-body text-center">
                <p class="mb-4">
                    Import your identity token into your wallet.
                    If you are not verified yet, you will be asked to verify with <strong>MitID</strong>.
                </p>

                <div class="d-grid gap-2 col-8 mx-auto mt-4">
                    <!-- IMPORT TOKEN -->
                    <button class="btn btn-lg btn-primary shadow-sm hover-elevate"
                            @onclick="ImportTokenAsync"
                            disabled="@_busy">
                        <span class="bi bi-download me-2"></span>
                        @(_busy ? "Importing..." : "Import token")
                    </button>

                    <!-- MITID FALLBACK -->
                    @if (_showMitIdButton)
                    {
                        <button class="btn btn-lg btn-outline-primary shadow-sm hover-elevate"
                                @onclick="StartMitIdLogin"
                                disabled="@_busy">
                            <span class="bi bi-person-badge me-2"></span>
                            Verify with MitID
                        </button>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(_error))
                {
                    <div class="alert alert-danger mt-3 text-start">
                        <small>@_error</small>
                    </div>
                }

                <div class="mt-4 text-muted small">
                    <p>
                        Issues? Ensure you have <a href="/signup">created an account</a> and are logged in.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool _busy;
    private string _error = "";
    private bool _showMitIdButton;

    // Renamed from ImportToken -> ImportTokenAsync to avoid name collision with the generated component class
    private async Task ImportTokenAsync()
    {
        _busy = true;
        _error = "";
        _showMitIdButton = false;

        try
        {
            await WalletService.IssueAndImportAdultTokenAsync();
            Nav.NavigateTo("/wallet");
        }
        catch (UnauthorizedAccessException)
        {
            _error = "You are not logged in. Please log in first.";
        }
        catch (InvalidOperationException)
        {
            // Typisk: ikke MitID verified / ikke 18+
            _error = "You are not MitID verified as 18+ yet. Please verify with MitID.";
            _showMitIdButton = true;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task StartMitIdLogin()
    {
        _busy = true;
        _error = "";

        try
        {
            var accountId = await WalletStorage.GetAccountIdAsync();
            if (accountId == Guid.Empty)
            {
                _error = "No AccountId found. Please create an account first.";
                return;
            }

            /*
             * DEV NOTE:
             * ----------
             * MitID (OIDC + PAR) requires HTTPS and behaves poorly behind gateway in dev.
             * Therefore we redirect directly to BachMitID in dev.
             *
             * In prod this can be moved behind gateway.
             */
            var loginUrl =
                $"http://localhost:7004/auth/login?accountId={accountId}&returnUrl=/wallet/import";

            // forceLoad=true is required for OIDC redirects
            Nav.NavigateTo(loginUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }
}
