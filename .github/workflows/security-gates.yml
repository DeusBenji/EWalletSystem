name: Security Gates

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [feat/*, fix/*]

jobs:
  security-invariants:
    name: Security Invariant Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Restore dependencies
        run: dotnet restore EWalletSystem.sln
      
      - name: Run Security Invariant Tests
        run: |
          dotnet test EWalletSystem.sln \
            --filter "Category=SecurityInvariant" \
            --logger "trx;LogFileName=security-tests.trx" \
            --no-restore
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: '**/security-tests.trx'
  
  pii-detection:
    name: PII Leak Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Scan for forbidden PII claims in logs
        run: |
          echo "Scanning for PII in log statements..."
          
          # Forbidden claim names
          FORBIDDEN_PATTERNS="birthdate|birthYear|cpr|ssn|nationalId|fullName|firstName|lastName|phoneNumber|postalCode"
          
          # Search in C# files for logging statements
          if grep -rn --include="*.cs" -E "Log(Information|Warning|Error|Debug).*($FORBIDDEN_PATTERNS)" src/; then
            echo "‚ùå FAILURE: PII detected in log statements!"
            echo "Found forbidden claims in logs. Use SafeLogger to redact PII."
            exit 1
          else
            echo "‚úÖ SUCCESS: No PII detected in logs"
            exit 0
          fi
      
      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
  
  threat-model-check:
    name: Threat Model Up-to-Date
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if threat model exists
        run: |
          if [ ! -f "docs/threat-model.md" ]; then
            echo "‚ùå FAILURE: docs/threat-model.md not found!"
            exit 1
          fi
          echo "‚úÖ Threat model exists"
      
      - name: Check if protocol changes require threat model update
        run: |
          # Check if protocol.md changed but threat-model.md didn't
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "docs/protocol.md"; then
            if ! git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "docs/threat-model.md"; then
              echo "‚ö†Ô∏è  WARNING: protocol.md changed but threat-model.md didn't"
              echo "Please review if threat model needs updating"
              # Don't fail, just warn (can be made stricter)
              exit 0
            fi
          fi
          echo "‚úÖ Threat model check passed"
  
  dependency-audit:
    name: Dependency Vulnerability Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Audit .NET dependencies
        run: |
          echo "Scanning for vulnerable .NET packages..."
          dotnet list package --vulnerable --include-transitive > vuln-report.txt 2>&1 || true
          
          if grep -q "has the following vulnerable packages" vuln-report.txt; then
            echo "‚ùå FAILURE: Vulnerable dependencies detected!"
            cat vuln-report.txt
            
            # Check severity
            if grep -qE "Severity: Critical|Severity: High" vuln-report.txt; then
              echo "‚õî BLOCKING: High/Critical severity vulnerabilities found!"
              exit 1
            else
              echo "‚ö†Ô∏è  WARNING: Medium/Low severity vulnerabilities found"
              exit 0
            fi
          else
            echo "‚úÖ No vulnerable dependencies found"
            exit 0
          fi
      
      - name: Setup Node.js (for extension)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Audit npm dependencies
        run: |
          if [ -f "src/Clients/BrowserExtension/package.json" ]; then
            cd src/Clients/BrowserExtension
            npm audit --production --audit-level=high
          else
            echo "No extension package.json yet, skipping npm audit"
          fi
  
  manifest-security:
    name: Extension Manifest Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check extension manifest permissions
        run: |
          MANIFEST="src/Clients/BrowserExtension/manifest.json"
          
          if [ ! -f "$MANIFEST" ]; then
            echo "Extension manifest not yet created, skipping"
            exit 0
          fi
          
          echo "Checking manifest.json security..."
          
          # Check for dangerous permissions
          if grep -q '"<all_urls>"' "$MANIFEST"; then
            echo "‚ùå FAILURE: Dangerous permission <all_urls> detected!"
            echo "Use activeTab instead for least privilege"
            exit 1
          fi
          
          if grep -q '"tabs"' "$MANIFEST" && ! grep -q '"activeTab"' "$MANIFEST"; then
            echo "‚ö†Ô∏è  WARNING: 'tabs' permission without activeTab might be excessive"
          fi
          
          # Check for CSP
          if ! grep -q "content_security_policy" "$MANIFEST"; then
            echo "‚ö†Ô∏è  WARNING: No Content-Security-Policy defined"
          fi
          
          echo "‚úÖ Manifest security check passed"
  
  security-gate-summary:
    name: Security Gate Summary
    runs-on: ubuntu-latest
    needs: [security-invariants, pii-detection, threat-model-check, dependency-audit, manifest-security]
    if: always()
    
    steps:
      - name: Check all gates passed
        run: |
          echo "üîí Security Gates Summary:"
          echo "- Security Invariants: ${{ needs.security-invariants.result }}"
          echo "- PII Detection: ${{ needs.pii-detection.result }}"
          echo "- Threat Model: ${{ needs.threat-model-check.result }}"
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}"
          echo "- Manifest Security: ${{ needs.manifest-security.result }}"
          
          if [ "${{ needs.security-invariants.result }}" != "success" ] || \
             [ "${{ needs.pii-detection.result }}" != "success" ] || \
             [ "${{ needs.dependency-audit.result }}" != "success" ]; then
            echo "‚ùå Security gates FAILED - PR cannot be merged"
            exit 1
          else
            echo "‚úÖ All security gates PASSED"
            exit 0
          fi
