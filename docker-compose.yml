version: "3.9"

services:
  # =========================
  # Infra: Zookeeper + Kafka
  # =========================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

      KAFKA_LISTENERS: PLAINTEXT_HOST://0.0.0.0:9092,PLAINTEXT_DOCKER://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT_HOST://localhost:9092,PLAINTEXT_DOCKER://kafka:29092

      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT_HOST:PLAINTEXT,PLAINTEXT_DOCKER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_DOCKER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

  kafdrop:
    image: obsidiandynamics/kafdrop
    container_name: kafdrop
    ports:
      - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: "kafka:29092"
    depends_on:
      - kafka

  # ==============
  # Infra: Redis
  # ==============
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]

  # ==============
  # Infra: SQL Server
  # ==============
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "YourStrong!Password"
    ports:
      - "1433:1433"
    restart: unless-stopped

  # =====================
  # Go fabric resolver
  # =====================
  fabric-resolver:
    build:
      context: ./src/Services/GoServices/fabric-resolver
      dockerfile: Dockerfile
    container_name: fabric-resolver
    ports:
      - "7000:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # =====================
  # ZKP Service (Go)
  # =====================
  zkp-service:
    build:
      context: ./src/Services/GoServices/zkp-service
      dockerfile: Dockerfile
    container_name: zkp-service
    ports:
      - "7006:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3


  # =====================
  # Account service
  # =====================
  account-service:
    build:
      context: .
      dockerfile: src/Services/Account/AccountService.Api/Dockerfile
    container_name: account-service
    ports:
      - "7001:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      
      # DB (Docker)
      ConnectionStrings__DefaultConnection: "Server=sqlserver;Database=AccountServiceDB;User Id=sa;Password=YourStrong!Password;TrustServerCertificate=True;"

      # Redis (Docker)
      ConnectionStrings__Redis: "redis:6379,abortConnect=false"

      # Kafka (Docker)
      Kafka__BootstrapServers: "kafka:29092"
      Kafka__GroupId: "account-service-mitid"

      # JWT (Docker)  # ADDED
      Jwt__Issuer: "ApiGateway"
      Jwt__Audience: "AccountService"
      Jwt__Key: "DEV_SUPER_SECRET_KEY_1234567890_ABCD"
    depends_on:
      - sqlserver
      - fabric-resolver
      - kafka
      - redis

  # =====================
  # Validation service
  # =====================
  validation-service:
    build:
      context: .
      dockerfile: src/Services/Validation/ValidationService.Api/Dockerfile
    container_name: validation-service
    ports:
      - "7002:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"

      # DB (Docker)
      ConnectionStrings__DefaultConnection: "Server=sqlserver;Database=ValidationServiceDB;User Id=sa;Password=YourStrong!Password;TrustServerCertificate=True;"
      ConnectionStrings__Redis: "redis:6379"

      # Fabric
      Fabric__BaseUrl: "http://fabric-resolver:8080"

      # Kafka
      Kafka__BootstrapServers: "kafka:29092"

      # JWT (Docker)  # ADDED
      Jwt__Issuer: "ApiGateway"
      Jwt__Audience: "ValidationService"
      Jwt__Key: "DEV_SUPER_SECRET_KEY_1234567890_ABCD"
    depends_on:
      - sqlserver
      - kafka
      - redis
      - fabric-resolver

  # =====================
  # Token service
  # =====================
  token-service:
    build:
      context: .
      dockerfile: src/Services/Token/TokenService.Api/Dockerfile
    container_name: token-service
    ports:
      - "7003:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"

      # DB (Docker)
      ConnectionStrings__TokenServiceConnection: "Server=sqlserver;Database=TokenServiceDB;User Id=sa;Password=YourStrong!Password;TrustServerCertificate=True;"
      ConnectionStrings__Redis: "redis:6379"

      # Fabric (Docker)
      Fabric__BaseUrl: "http://fabric-resolver:8080"

      # Kafka
      Kafka__BootstrapServers: "kafka:29092"
      Kafka__GroupId: "token-service-mitid"

      # JWT (Docker)  # ADDED
      Jwt__Issuer: "ApiGateway"
      Jwt__Audience: "TokenService"
      Jwt__Key: "DEV_SUPER_SECRET_KEY_1234567890_ABCD"
    depends_on:
      - sqlserver
      - validation-service
      - account-service
      - kafka
      - redis

  # =====================
  # Identity Service (Signicat)
  # =====================
  identity-service:
    build:
      context: .
      dockerfile: src/Services/IdentityService/IdentityService.API/Dockerfile
    container_name: identity-service
    ports:
      - "7004:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: "Development"
      Wallet__BaseUrl: "http://localhost:8081"

      # DB (Docker)
      # Note: Database name might need update if migration script didn't rename DB
      ConnectionStrings__CompanyConnection: "Server=sqlserver;Database=IdentityServiceDB;User Id=sa;Password=YourStrong!Password;TrustServerCertificate=True;"
      ConnectionStrings__RedisConnection: "redis:6379"

      # Kafka
      Kafka__BootstrapServers: "kafka:29092"

      # 🔐 Signicat / OIDC
      Authentication__Authority: "https://bentest.sandbox.signicat.com/auth/open"
      Authentication__ClientId: "sandbox-vast-knee-978"
      Authentication__ClientSecret: "c26o448VVUR1nzjEPkY7YpnC4MLG1sPTcj9vrUEAf5Y67DyF"
      Authentication__CallbackPath: "/signin-oidc"

      # JWT (must match gateway)
      Jwt__Issuer: "ApiGateway"
      Jwt__Audience: "IdentityService"
      Jwt__Key: "DEV_SUPER_SECRET_KEY_1234567890_ABCD"
    depends_on:
      - sqlserver
      - account-service
      - token-service
      - kafka
      - redis

  # =====================
  # API Gateway (YARP)
  # =====================
  apigateway:
    build:
      context: .
      dockerfile: src/Gateway/ApiGateway/Dockerfile
    container_name: apigateway
    ports:
      - "7005:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"

      # JWT settings (must match IdentityService)
      Jwt__Issuer: "ApiGateway"
      Jwt__Audience: "IdentityService" # Updated audience
      Jwt__Key: "DEV_SUPER_SECRET_KEY_1234567890_ABCD"

      # 🔥 YARP overrides (Docker-netværk)
      ReverseProxy__Clusters__mitid-cluster__Destinations__mitid-api__Address: "http://identity-service:8080/"
      ReverseProxy__Clusters__account-cluster__Destinations__account-api__Address: "http://account-service:8080/"
      ReverseProxy__Clusters__validation-cluster__Destinations__validation-api__Address: "http://validation-service:8080/"
      ReverseProxy__Clusters__token-cluster__Destinations__token-api__Address: "http://token-service:8080/"

    depends_on:
      - identity-service
      - account-service
      - validation-service
      - token-service

  # =====================
  # Prometheus
  # =====================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    restart: unless-stopped

  # =====================
  # Wallet Frontend (Blazor WASM)
  # =====================
  wallet-frontend:
    build:
      context: .
      dockerfile: src/Clients/Wallet.Wasm/Dockerfile
    container_name: wallet-frontend
    ports:
      - "8081:80"
    restart: unless-stopped
    depends_on:
      - apigateway

networks:
  default:
    name: bachelor-net
