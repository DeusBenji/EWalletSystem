version: "3.9"

services:
  fabric-resolver:
    build:
      context: ./src/Services/GoServices/fabric-resolver
      dockerfile: Dockerfile
    container_name: fabric-resolver
    ports:
      - "7000:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  account-service:
    build:
      context: .
      dockerfile: src/Services/Account/API/Dockerfile
    container_name: account-service
    ports:
      - "7001:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ConnectionStrings__DefaultConnection: "Server=sqlserver;Database=AccountDb;User Id=sa;Password=YourStrong!Password;TrustServerCertificate=True;"
      Kafka__BootstrapServers: "kafka:9092"
    depends_on:
      - fabric-resolver

  validation-service:
    build:
      context: .
      dockerfile: src/Services/Validation/API/Dockerfile
    container_name: validation-service
    ports:
      - "7002:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      Kafka__BootstrapServers: "kafka:9092"
      ConnectionStrings__Redis: "redis:6379"

  token-service:
    build:
      context: .
      dockerfile: src/Services/Token/API/Dockerfile
    container_name: token-service
    ports:
      - "7003:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      Kafka__BootstrapServers: "kafka:9092"
      ConnectionStrings__Redis: "redis:6379"
    depends_on:
      - validation-service
      - account-service

  bachmitid-api:
    build:
      context: .
      dockerfile: src/Services/BachMitID/BachMitID/Dockerfile
    container_name: bachmitid-api
    ports:
      - "7004:8080"
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      Kafka__BootstrapServers: "kafka:9092"
    depends_on:
      - account-service
      - token-service

networks:
  default:
    name: bachelor-net
